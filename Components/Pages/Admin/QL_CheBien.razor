@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using FROASTERY.Services;
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IHttpContextAccessor HttpContextAccessor

@code {
    private ClaimsPrincipal? _currentUser;

    // Thay ƒë·ªïi t·ª´ OnInitializedAsync sang OnAfterRenderAsync
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // L·∫•y tr·∫°ng th√°i x√°c th·ª±c c·ªßa ng∆∞·ªùi d√πng
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                _currentUser = authState.User;

                // In th√¥ng tin ng∆∞·ªùi d√πng v√† tr·∫°ng th√°i x√°c th·ª±c
                Console.WriteLine("User: " + _currentUser?.Identity?.Name);
                Console.WriteLine("UserId: " + _currentUser?.FindFirst("UserId")?.Value); // In m√£ ng∆∞·ªùi d√πng
                Console.WriteLine("Is Authenticated: " + _currentUser?.Identity?.IsAuthenticated);

                // Ki·ªÉm tra n·∫øu ng∆∞·ªùi d√πng ch∆∞a x√°c th·ª±c
                if (_currentUser?.Identity == null || !_currentUser.Identity.IsAuthenticated)
                {
                    Console.WriteLine("User not authenticated.");
                    // Chuy·ªÉn h∆∞·ªõng ng∆∞·ªùi d√πng ƒë·∫øn trang ƒëƒÉng nh·∫≠p n·∫øu ch∆∞a x√°c th·ª±c
                    Navigation.NavigateTo("/dangnhap", true);
                    return;
                }

                // Ki·ªÉm tra quy·ªÅn Admin
                if (!_currentUser.IsInRole("Admin") &&
                !_currentUser.IsInRole("Kinh doanh") )
                    
                {
                    Console.WriteLine("User does not have Admin role. Redirecting to /home.");
                    // Chuy·ªÉn h∆∞·ªõng ng∆∞·ªùi d√πng kh√¥ng ph·∫£i Admin v·ªÅ trang ch·ªß
                    Navigation.NavigateTo("/home_admin", true);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine("Error during authentication check: " + ex.Message);
            }
        }
    }
}




@page "/chebien"
@using Microsoft.EntityFrameworkCore
@inject AppDbContext DbContext
@inject IWebHostEnvironment Environment
@rendermode InteractiveServer
@using FROASTERY.Models
@using FROASTERY.Data
@using System.IO
@using FROASTERY.Components.Shared
<link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="custom.css" />
<style>
    .description {
        max-height: 100px; /* Gi·ªõi h·∫°n chi·ªÅu cao c·ªßa m√¥ t·∫£ */
        overflow: hidden; /* ·∫®n ph·∫ßn n·ªôi dung v∆∞·ª£t qu√° */
        transition: max-height 0.3s ease-out;
    }

    .expanded {
        max-height: none; /* Hi·ªÉn th·ªã to√†n b·ªô khi m·ªü r·ªông */
    }
</style>
<ErrorDisplay ErrorMessage="@DbErrorMessage" OnClear="ClearErrorMessage" />

<PageTitle>Qu·∫£n l√Ω Ch·∫ø Bi·∫øn</PageTitle>

<div class="container mt-4">
    <h3 class="text-center mb-4">Qu·∫£n l√Ω Ch·∫ø Bi·∫øn</h3>
    <h5>@(Editing ? "Ch·ªânh s·ª≠a" : "Th√™m m·ªõi") Ch·∫ø Bi·∫øn</h5>

    <EditForm Model="CheBien" OnValidSubmit="SaveAsync" class="border p-4 rounded shadow bg-light mb-4">
        <DataAnnotationsValidator />
        <div class="row mb-3">
            <!-- C·ªôt b√™n tr√°i -->
            <div class="col-md-2">
                <label>M√£ Ch·∫ø Bi·∫øn:</label>
                <input type="text" @bind="CheBien.MaCheBien" class="form-control mb-2" readonly />
            </div>
            <div class="col-md-4">
                <label>Th·ªùi gian:</label>
                <div class="position-relative mb-2 validation-wrapper">
                    <input type="datetime-local" @bind="CheBien.ThoiGian" class="form-control mb-2" />
                    <ValidationMessage For="@(() => CheBien.ThoiGian)" />
                </div>
            </div>
            <div class="col-md-2">
                <label>S·ªë l∆∞·ª£ng:</label>
                <div class="position-relative mb-2 validation-wrapper">
                    <input type="number" step="1" @bind="CheBien.SoLuongSP" class="form-control mb-2" />
                    <ValidationMessage For="@(() => CheBien.SoLuongSP)" />
                </div>
                
            </div>
            <div class="col-md-4">
                <label>S·∫£n ph·∫©m:</label>
                <select @bind="CheBien.MaSanPham"  @bind:after= "OnSanPhamChanged" class="form-control mb-2">
                    <option value="0">-- Ch·ªçn S·∫£n Ph·∫©m --</option>
                    @foreach (var sp in SanPhams)
                    {
                        <option value="@sp.MaSanPham">@sp.TenSanPham</option>
                    }
                </select>
            </div>   
            
        </div>

    <div class="row mb-3">
    <div class="col-md-8">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="d-inline-block ">Th√¥ng Tin Nguy√™n Li·ªáu</h5>
            <button type="button" @onclick="AddNguyenLieu" class="btn btn-success btn-sm px-4 ms-3">Th√™m Nguy√™n Li·ªáu</button>
        </div>
        <table class="table mt-3">
            <thead>
                <tr>
                    <th>Nguy√™n Li·ªáu</th>
                    <th style="width: 180px">S·ªë L∆∞·ª£ng</th>
                    <th style="width: 120px">ƒê∆°n v·ªã t√≠nh</th>     
                    <th style="width: 100px"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var ct in ChiTietCheBiens)
                {
                    var nguyenLieu = NguyenLieus.FirstOrDefault(nl => nl.MaNguyenLieu == ct.MaNguyenLieu);

                    <tr>
                        <td>
                            <select @bind="ct.MaNguyenLieu" class="form-control">
                                @foreach (var nl in NguyenLieus)
                                {
                                    <option value="@nl.MaNguyenLieu">@nl.TenNguyenLieu</option>
                                }
                            </select>
                        </td>
                        <td>
                            <input type="number" step="0.01" @bind="ct.SoLuong" class="form-control" />
                        </td>
                        <td>
                            @nguyenLieu?.DonViTinh
                        </td>
                        <td>
                            <button type="button" @onclick="() => RemoveNguyenLieu(ct)" class="btn btn-danger">X√≥a</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        </div>
        <div class="col-md-4">
               <label>C√¥ng Th·ª©c:</label>
                <textarea class="form-control mb-2" rows="6" readonly>@NoiDungCongThuc</textarea>
        </div>
    </div>  
        <div class="d-flex justify-content-center gap-3 mt-2">
            <button type="submit" class="btn btn-save">L∆∞u</button>
            <button type="button" class="btn btn-cancel" @onclick="ResetForm">H·ªßy</button>
        </div>
    </EditForm>

    <div class="card p-3 mb-4 shadow-sm">
    <div class="row g-2 align-items-end">
        <!-- √î t√¨m ki·∫øm t·ª´ kh√≥a -->
        <div class="col-md-4">
            <label class="form-label">T√¨m ki·∫øm</label>
            <input type="text" @bind="SearchQuery" class="form-control"
                   placeholder="Nh·∫≠p th√¥ng tin s·∫£n ph·∫©m,..." />
        </div>

        <div class="col-md-3">
            <label class="form-label">T·ª´ ng√†y</label>
            <input type="date" @bind="StartDate" class="form-control" />
        </div>

        <div class="col-md-3">
            <label class="form-label">ƒê·∫øn ng√†y</label>
            <input type="date" @bind="EndDate" class="form-control" />
        </div>

        <!-- N√∫t t√¨m ki·∫øm n·∫±m ngang h√†ng v√† cƒÉn ph·∫£i -->
        <div class="col-md-2 d-flex justify-content-end">
            <button @onclick="Search" class="btn btn-success px-4">T√¨m ki·∫øm</button>
        </div>
    </div>
</div>


    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th style="width: 60px">M√£</th>
                    <th style ="width: 110px">Th·ªùi Gian</th>
                    <th style ="width: 200px">S·∫£n Ph·∫©m</th>
                    <th style ="width: 60px">SL SP</th>
                    <th style ="width: 250px">Nguy√™n Li·ªáu</th>
                    <th>C√¥ng Th·ª©c</th>
                    <th style="width: 128px">H√†nh ƒê·ªông</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var cb in CheBiens)
                {
                    <tr>
                        <td>@cb.MaCheBien</td>
                        <td>@cb.ThoiGian.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>@cb.SanPham?.TenSanPham</td>
                        <td>@cb.SoLuongSP</td>
                        <td>
                            @if (CheBiens != null && cb.CTCBNguyenLieus != null)
                        {
                            <ul>
                            @foreach (var ct in cb.CTCBNguyenLieus)
                            {
                                var nguyenLieu = NguyenLieusAll.FirstOrDefault(nl => nl.MaNguyenLieu == ct.MaNguyenLieu);
                                if (nguyenLieu != null)
                                {
                                    <li>
                                        @nguyenLieu?.TenNguyenLieu: @ct.SoLuong @nguyenLieu?.DonViTinh
                                    </li>
                                }
                            }
                            </ul>
                        }
                            
                        </td>

                        <td>
                            @if (cb.MaCongThuc.HasValue)
                            {
                                <div class="description @(detailExpandedClass.ContainsKey(cb.MaCongThuc.Value) && detailExpandedClass[cb.MaCongThuc.Value] ? "expanded" : "")">
                                    @((MarkupString)(cb.CongThuc?.CongThucMoTa != null ? cb.CongThuc.CongThucMoTa.Replace("\r\n", "<br/>").Replace("\n", "<br/>") : "")) 
                                </div>
                                @if (!string.IsNullOrEmpty(cb.CongThuc?.CongThucMoTa) && cb.CongThuc.CongThucMoTa.Length > 100)
                                {
                                    <button class="btn btn-link p-0 shadow-none fst-italic small" @onclick="() => ToggleDetail(cb.MaCongThuc.Value)">
                                        @(detailExpandedClass.ContainsKey(cb.MaCongThuc.Value) && detailExpandedClass[cb.MaCongThuc.Value] ? "·∫®n b·ªõt" : "Xem th√™m")
                                    </button>
                                }
                            }

                        </td>

                        <td>
                            <button class="btn btn-warning mb-1" @onclick="() => EditCheBien(cb)">S·ª≠a</button>
                            <button class="btn btn-danger" @onclick="() => DeleteCheBien(cb.MaCheBien)">X√≥a</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    private List<CheBien> CheBiens = new();
    private List<CheBien> FullCheBiens = new();  
    private List<SanPham> SanPhams = new();
    private List<NguyenLieu> NguyenLieus = new();
             private List<NguyenLieu> NguyenLieusAll = new();
    private List<CTCBNguyenLieu> ChiTietCheBiens = new();
    private CheBien CheBien = new();
    private bool Editing = false;
    private string NoiDungCongThuc = string.Empty;

   private string? SearchQuery { get; set; }
    private DateTime? StartDate { get; set; }
    private DateTime? EndDate { get; set; }

    
    protected override async Task OnInitializedAsync()
    {
       FullCheBiens = await DbContext.CheBiens
            .Include(p => p.SanPham)
            .Include(p => p.CongThuc) // üëà TH√äM D√íNG N√ÄY
            .Include(p => p.CTCBNguyenLieus)
            .ThenInclude(ct => ct.NguyenLieu)
            .Where(p => !p.DaXoa)
            .AsNoTracking()
            .ToListAsync();
        CheBiens = new List<CheBien>(FullCheBiens);
        SanPhams = await DbContext.SanPhams.AsNoTracking().Where(p => !p.DaXoa).ToListAsync();
        NguyenLieus = await DbContext.NguyenLieus.AsNoTracking().Where(p => !p.DaXoa).ToListAsync();
        NguyenLieusAll = await DbContext.NguyenLieus.AsNoTracking().ToListAsync();
        CheBiens.Reverse();
    }

   private async Task CapNhatKhoSanPhamAsync(int? maSanPhamCu, int? maSanPhamMoi, int soLuongCu, int soLuongMoi)
{
    // 1. C·∫≠p nh·∫≠t s·∫£n ph·∫©m m·ªõi (n·∫øu c√≥)
    if (maSanPhamMoi.HasValue)
    {
        var sanPhamMoi = await DbContext.SanPhams.FirstOrDefaultAsync(sp => sp.MaSanPham == maSanPhamMoi.Value);
        if (sanPhamMoi != null)
        {
            int chenhlech = soLuongMoi;
            if (maSanPhamCu == maSanPhamMoi)
            {
                // N·∫øu kh√¥ng ƒë·ªïi s·∫£n ph·∫©m, ch·ªâ t√≠nh ch√™nh l·ªách
                chenhlech = soLuongMoi - soLuongCu;
            }

            Console.WriteLine($"[C·∫≠p nh·∫≠t] S·∫£n ph·∫©m m·ªõi {sanPhamMoi.MaSanPham}: c≈© {soLuongCu}, m·ªõi {soLuongMoi}, ch√™nh l·ªách {chenhlech}");

            sanPhamMoi.SoLuong = (sanPhamMoi.SoLuong ?? 0) + chenhlech;
            if (sanPhamMoi.SoLuong < 0)
                sanPhamMoi.SoLuong = 0;
        }
        else
        {
            Console.WriteLine($"[Kh√¥ng t√¨m th·∫•y] S·∫£n ph·∫©m m·ªõi {maSanPhamMoi.Value}");
        }
    }

    // 2. N·∫øu s·∫£n ph·∫©m c≈© kh√°c s·∫£n ph·∫©m m·ªõi ‚Üí gi·∫£m s·ªë l∆∞·ª£ng s·∫£n ph·∫©m c≈©
    if (maSanPhamCu.HasValue && maSanPhamCu != maSanPhamMoi)
    {
        var sanPhamCu = await DbContext.SanPhams.FirstOrDefaultAsync(sp => sp.MaSanPham == maSanPhamCu.Value);
        if (sanPhamCu != null)
        {
            Console.WriteLine($"[Gi·∫£m] S·∫£n ph·∫©m c≈© {sanPhamCu.MaSanPham}: gi·∫£m {soLuongCu}");
            sanPhamCu.SoLuong = (sanPhamCu.SoLuong ?? 0) - soLuongCu;
            if (sanPhamCu.SoLuong < 0)
                sanPhamCu.SoLuong = 0;
        }
        else
        {
            Console.WriteLine($"[Kh√¥ng t√¨m th·∫•y] S·∫£n ph·∫©m c≈© {maSanPhamCu.Value}");
        }
    }
}



    
    private async Task SaveAsync()
    {
        DbErrorMessage = null; 
        if (!ValidateChiTietPhieuNhap())
        {
            return;
        }
        // Ki·ªÉm tra kho nguy√™n li·ªáu tr∆∞·ªõc khi th·ª±c hi·ªán l∆∞u
        
        try
        {
            if (Editing)
            {
                if (!await KiemTraKhoNguyenLieuAsync(ChiTietCheBiens, ChiTietCu))  // Ki·ªÉm tra kho tr∆∞·ªõc
                {
                    return;  // N·∫øu kh√¥ng ƒë·ªß kho, d·ª´ng l·∫°i
                }
                var existingCheBien = await DbContext.CheBiens
                    .Include(c => c.CTCBNguyenLieus)
                    .FirstOrDefaultAsync(c => c.MaCheBien == CheBien.MaCheBien);

                if (existingCheBien != null)
                {
                    int soLuongCu = existingCheBien.SoLuongSP ?? 0;

                    await CapNhatKhoSanPhamAsync(
    existingCheBien.MaSanPham,
    CheBien.MaSanPham,
    existingCheBien.SoLuongSP ?? 0,
    CheBien.SoLuongSP ?? 0);


                    await CapNhatKhoTheoChiTietAsync(ChiTietCu, ChiTietCheBiens);
                    // C·∫≠p nh·∫≠t th√¥ng tin ch√≠nh
                    existingCheBien.ThoiGian = CheBien.ThoiGian;
                    existingCheBien.MaSanPham = CheBien.MaSanPham;
                    existingCheBien.SoLuongSP = CheBien.SoLuongSP;
                    existingCheBien.MaCongThuc = CheBien.MaCongThuc;

                    
                    // X√≥a h·∫øt chi ti·∫øt c≈©
                    existingCheBien.CTCBNguyenLieus.Clear();

                    // Th√™m l·∫°i chi ti·∫øt m·ªõi
                    foreach (var ct in ChiTietCheBiens)
                    {
                        existingCheBien.CTCBNguyenLieus.Add(new CTCBNguyenLieu
                        {
                            MaNguyenLieu = ct.MaNguyenLieu,
                            SoLuong = ct.SoLuong,
                        });
                    }

                    await DbContext.SaveChangesAsync();
                }
            }
            else
            {
                if (!await KiemTraKhoNguyenLieuAsync(ChiTietCheBiens,new List<CTCBNguyenLieu>() ))  // Ki·ªÉm tra kho tr∆∞·ªõc
                {
                    return;  // N·∫øu kh√¥ng ƒë·ªß kho, d·ª´ng l·∫°i
                }
                // Th√™m m·ªõi ch·∫ø bi·∫øn v√† chi ti·∫øt
                DbContext.CheBiens.Add(CheBien);
                await DbContext.SaveChangesAsync();

                foreach (var ct in ChiTietCheBiens)
                {
                    ct.MaCheBien = CheBien.MaCheBien;
                    await DbContext.CTCBNguyenLieus.AddAsync(ct);
                }

                await DbContext.SaveChangesAsync();
                await CapNhatKhoSanPhamAsync(
                    null,
                    CheBien.MaSanPham,
                    0,
                    CheBien.SoLuongSP ?? 0);
                await CapNhatKhoTheoChiTietAsync(new List<CTCBNguyenLieu>(), ChiTietCheBiens);
                await DbContext.SaveChangesAsync();
            }

            await OnInitializedAsync();
            ResetForm();


        }
        catch (Exception ex)
        {
            DbErrorMessage = $"L·ªói: {ex.Message}";
        }
    }

    private List<CTCBNguyenLieu> ChiTietCu = new();
    private async Task EditCheBien(CheBien cb)
    {
        CheBien = new CheBien
        {
            MaCheBien = cb.MaCheBien,
            ThoiGian = cb.ThoiGian,
            MaSanPham = cb.MaSanPham,
            SoLuongSP = cb.SoLuongSP,
            MaCongThuc = cb.MaCongThuc
        };
        ChiTietCheBiens = cb.CTCBNguyenLieus
            .Select(ct => new CTCBNguyenLieu
            {
                MaCheBien = ct.MaCheBien,
                MaNguyenLieu = ct.MaNguyenLieu,
                SoLuong = ct.SoLuong
            })
            .ToList();

        ChiTietCu = ChiTietCheBiens.Select(ct => new CTCBNguyenLieu
            {
                MaCheBien = ct.MaCheBien,
                MaNguyenLieu = ct.MaNguyenLieu,
                SoLuong = ct.SoLuong,
               
            }).ToList();
        Editing = true;
        await OnSanPhamChanged();
       
      
    }

    private async Task DeleteCheBien(int id)
    {
       var entity = await DbContext.CheBiens.FindAsync(id);

        if (entity != null)
        {
            var details = DbContext.CTCBNguyenLieus.Where(ct => ct.MaCheBien == id);
            // Tr·ª´ l·∫°i s·ªë l∆∞·ª£ng s·∫£n ph·∫©m ƒë√£ c·ªông tr∆∞·ªõc ƒë√≥
            await CapNhatKhoSanPhamAsync(
                entity.MaSanPham,
                null,
                entity.SoLuongSP ?? 0,
                0);
 // soLuongCu = hi·ªán t·∫°i, soLuongMoi = 0
        // C·∫≠p nh·∫≠t kho l·∫°i theo c√°c chi ti·∫øt phi·∫øu nh·∫≠p ƒë√£ x√≥a
            await CapNhatKhoTheoChiTietAsync(details.ToList(), new List<CTCBNguyenLieu>());
            await DbContext.SaveChangesAsync();

            entity.DaXoa = true;
            @* DbContext.CheBiens.Remove(entity); *@
            await DbContext.SaveChangesAsync();
            await OnInitializedAsync();
        }
    }

   

    private void ResetForm()
    {
        CheBien = new CheBien();
        ChiTietCheBiens.Clear();
        Editing = false;
        DbErrorMessage = null;
        NoiDungCongThuc = string.Empty;
    }

    private async Task<bool> KiemTraKhoNguyenLieuAsync(
    List<CTCBNguyenLieu> chiTietMoi,
    List<CTCBNguyenLieu> chiTietCu)
{
    // L·∫•y danh s√°ch t·∫•t c·∫£ m√£ nguy√™n li·ªáu (c≈© + m·ªõi)
    var allKeys = chiTietMoi.Select(x => x.MaNguyenLieu)
                            .Union(chiTietCu.Select(x => x.MaNguyenLieu));

    foreach (var maNl in allKeys)
    {
        // L·∫•y s·ªë l∆∞·ª£ng t·ª´ chi ti·∫øt m·ªõi v√† chi ti·∫øt c≈©
        var moi = chiTietMoi.FirstOrDefault(x => x.MaNguyenLieu == maNl)?.SoLuong ?? 0;
        var cu = chiTietCu.FirstOrDefault(x => x.MaNguyenLieu == maNl)?.SoLuong ?? 0;

        var chenhlech = moi - cu;  // n·∫øu √¢m th√¨ ƒëang gi·∫£m, d∆∞∆°ng l√† tƒÉng

        if (chenhlech > 0)  // Ch·ªâ ki·ªÉm tra kho khi ch√™nh l·ªách l√† d∆∞∆°ng (tƒÉng)
        {
            var nguyenLieu = await DbContext.NguyenLieus
                .FirstOrDefaultAsync(nl => nl.MaNguyenLieu == maNl);
            if (nguyenLieu != null)
            {
                var soLuongTonKho = nguyenLieu.SoLuong ?? 0f;
                if (soLuongTonKho < chenhlech)
                {
                    DbErrorMessage = $"Nguy√™n li·ªáu '{nguyenLieu.TenNguyenLieu}' kh√¥ng ƒë·ªß kho ƒë·ªÉ c·∫≠p nh·∫≠t. Hi·ªán c√≤n {soLuongTonKho}, c·∫ßn th√™m {chenhlech}.";
                    return false;
                }
            }
            else
            {
                DbErrorMessage = $"Kh√¥ng t√¨m th·∫•y nguy√™n li·ªáu v·ªõi m√£ {maNl}.";
                return false;
            }
        }
    }

    return true; // Ki·ªÉm tra kho th√†nh c√¥ng
}



    private async Task CapNhatKhoTheoChiTietAsync(List<CTCBNguyenLieu> chiTietCu, List<CTCBNguyenLieu> chiTietMoi)
    {
        // 1. C·∫≠p nh·∫≠t nguy√™n li·ªáu c√≥ trong danh s√°ch m·ªõi
       // 1. C·∫≠p nh·∫≠t nguy√™n li·ªáu c√≥ trong danh s√°ch m·ªõi
    foreach (var chiTietMoiItem in chiTietMoi)
    {
        var nguyenLieu = await DbContext.NguyenLieus
            .FirstOrDefaultAsync(nl => nl.MaNguyenLieu == chiTietMoiItem.MaNguyenLieu);
        
        if (nguyenLieu != null)
        {
            var chiTietCuItem = chiTietCu.FirstOrDefault(x => x.MaNguyenLieu == nguyenLieu.MaNguyenLieu);
            float soLuongCu = chiTietCuItem?.SoLuong ?? 0f; // Thay int th√†nh float
            float soLuongMoi = chiTietMoiItem.SoLuong ?? 0f; // Thay int th√†nh float
            float chenhlech = soLuongMoi - soLuongCu;

            Console.WriteLine($"[C·∫≠p nh·∫≠t] Nguy√™n li·ªáu {nguyenLieu.MaNguyenLieu}: c≈© {soLuongCu}, m·ªõi {soLuongMoi}, ch√™nh l·ªách {chenhlech}");

            nguyenLieu.SoLuong = (float?)Math.Round((nguyenLieu.SoLuong ?? 0f) - chenhlech, 2);
            if (nguyenLieu.SoLuong < 0)
                nguyenLieu.SoLuong = 0f;
        }
        else
        {
            Console.WriteLine($"[Kh√¥ng t√¨m th·∫•y] Nguy√™n li·ªáu {chiTietMoiItem.MaNguyenLieu}");
        }
    }

    // 2. X·ª≠ l√Ω nguy√™n li·ªáu b·ªã x√≥a (c√≥ trong chiTietCu nh∆∞ng kh√¥ng c√≤n trong chiTietMoi)
    foreach (var chiTietCuItem in chiTietCu)
    {
        var stillExists = chiTietMoi.Any(x => x.MaNguyenLieu == chiTietCuItem.MaNguyenLieu);
        if (!stillExists)
        {
            var nguyenLieu = await DbContext.NguyenLieus
                .FirstOrDefaultAsync(nl => nl.MaNguyenLieu == chiTietCuItem.MaNguyenLieu);

            if (nguyenLieu != null)
            {
                Console.WriteLine($"[X√≥a] Nguy√™n li·ªáu {nguyenLieu.MaNguyenLieu}: gi·∫£m {chiTietCuItem.SoLuong}");

                nguyenLieu.SoLuong = (float?)Math.Round((nguyenLieu.SoLuong ?? 0f) + (chiTietCuItem.SoLuong ?? 0f), 2);

                if (nguyenLieu.SoLuong < 0)
                    nguyenLieu.SoLuong = 0f;
            }
        }
    }
}


    // H√†m t√¨m ki·∫øm
    private void Search()
    {
        var trimmedQuery = SearchQuery?.Trim();
        
            CheBiens = FullCheBiens.Where(item =>
                (
                     // ƒêi·ªÅu ki·ªán t√¨m theo t√™n s·∫£n ph·∫©m
            string.IsNullOrWhiteSpace(trimmedQuery) ||
            (item.SanPham?.TenSanPham?.Contains(trimmedQuery, StringComparison.OrdinalIgnoreCase) == true)
                ) 
                &&
                (
                    // L·ªçc theo kho·∫£ng th·ªùi gian
                    (!StartDate.HasValue || ( item.ThoiGian.Date >= StartDate.Value.Date)) &&
                    (!EndDate.HasValue || (item.ThoiGian.Date <= EndDate.Value.Date))
                )

            ).ToList();
            CheBiens.Reverse();
    }
     private async Task OnSanPhamChanged()
    {
        if (CheBien.MaSanPham != 0)
        {
            // T√¨m c√¥ng th·ª©c theo M√£ S·∫£n Ph·∫©m
            var congThuc = await DbContext.CongThucs
                .FirstOrDefaultAsync(ct => ct.MaSanPham == CheBien.MaSanPham);

            if (congThuc != null)
            {
                NoiDungCongThuc = congThuc.CongThucMoTa;  // Hi·ªÉn th·ªã n·ªôi dung
                CheBien.MaCongThuc = congThuc.MaCongThuc;    // L∆∞u m√£ c√¥ng th·ª©c ƒë·ªÉ sau n√†y l∆∞u v√†o b·∫£ng CheBien
            }
            else
            {
                NoiDungCongThuc = "Kh√¥ng t√¨m th·∫•y c√¥ng th·ª©c cho s·∫£n ph·∫©m n√†y.";
                CheBien.MaCongThuc = null;
            }
        }
        else
        {
            NoiDungCongThuc = string.Empty;
            CheBien.MaCongThuc = null;
        }
    }

    private bool ValidateChiTietPhieuNhap()
    {
        if (CheBien.MaSanPham == 0)
        {
            DbErrorMessage = "Vui l√≤ng ch·ªçn s·∫£n ph·∫©m.";
            return false;
        }

        if (ChiTietCheBiens == null || ChiTietCheBiens.Count == 0)
        {
            DbErrorMessage = "Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt nguy√™n li·ªáu tr∆∞·ªõc khi l∆∞u.";
            return false;
        }
        var spApDungIds = new HashSet<int>();
        foreach (var ct in ChiTietCheBiens)
        {
            if (ct.MaNguyenLieu == 0)
            {
                DbErrorMessage = "C√≥ nguy√™n li·ªáu ch∆∞a ƒë∆∞·ª£c ch·ªçn.";
                return false;
            }

            if (ct.SoLuong <= 0)
            {
                DbErrorMessage = "S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0 cho t·ª´ng nguy√™n li·ªáu.";
                return false;
            }

            
            if (!spApDungIds.Add(ct.MaNguyenLieu))
            {
                DbErrorMessage = "M·ªói nguy√™n li·ªáu ch·ªâ ƒë∆∞·ª£c ch·ªçn m·ªôt l·∫ßn.";
                return false;
            }
        }

        return true;
    }

    private void AddNguyenLieu()
    {
        ChiTietCheBiens.Add(new CTCBNguyenLieu());
    }

    private void RemoveNguyenLieu(CTCBNguyenLieu ct)
    {
        ChiTietCheBiens.Remove(ct);
    }

    private string? DbErrorMessage;
    private void ClearErrorMessage()
    {
        DbErrorMessage = null;
    }

    // =====code x·ª≠ l√Ω m·ªü r·ªông m√¥ t·∫£ v√† chi ti·∫øt=====
    private Dictionary<int, bool> descriptionExpandedClass = new();
    private Dictionary<int, bool> detailExpandedClass = new();

    private void ToggleDescription(int Id)
    {
        if (descriptionExpandedClass.ContainsKey(Id))
        {
            descriptionExpandedClass[Id] = !descriptionExpandedClass[Id];
        }
        else
        {
            descriptionExpandedClass[Id] = true;
        }
    }

    private void ToggleDetail(int Id)
    {
        if (detailExpandedClass.ContainsKey(Id))
        {
            detailExpandedClass[Id] = !detailExpandedClass[Id];
        }
        else
        {
            detailExpandedClass[Id] = true;
        }
    }
}
